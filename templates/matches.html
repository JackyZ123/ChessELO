{% extends 'layout.html' %}
{% block content %}

{% include 'side-nav.html' %}

<div class="content" id="content">
    <table class="matches"><tbody>
        <tr>
            <th style="width: 5%; z-index: 10;"></th>
            <th style="width: 30%;">White</th>
            <th style="width: 4%;"></th>
            <th style="width: 5%;"></th>
            <th style="width: 30%;">Black</th>
            <th style="width: 17%;">Date (UTC)</th>
        </tr>
        <form action="/new_match">
            <tr>
                <td style="height: 28px;"><input type="checkbox" name="" id="" style="width: 100%;"></td>
                <td><input type="text" placeholder="Player 1" id="player1" list="p1drop" onkeyup="autofill_matches(0)">
                    <datalist id="p1drop">
                    </datalist>
                </td>
                <td>vs</td>
                <td><input type="checkbox" name="" id="" style="width: 100%;"></td>
                <td><input type="text" placeholder="Player 2" id="player2" list="p2drop" onkeyup="autofill_matches(1)">
                    <datalist id="p2drop">
                    </datalist>
                </td>
                <td><input type="submit" value="Submit"></td>
            </tr>
        </form>
        {% for i in matches %}
            <tr>
                <td>{% if i[2] == i[3] %} <img src="/static/images/crown.png" alt="ðŸ‘‘" style="height: 20px; z-index: 5;"> {% endif %}</td>
                <td>{{i[4].title()}}</td>
                <td>vs</td>
                <td>{% if i[2] == i[5] %} <img src="/static/images/crown.png" alt="ðŸ‘‘" style="height: 20px;"> {% endif %}</td>
                <td>{{i[6].title()}}</td>
                <td style="margin-left: auto; margin-right: auto;">{{i[1]}}</td>
            </tr>
        {% endfor %}
    </tbody></table>

    <script>
        function submit(){
            return;
        }

        function autofill_matches(caller){
            var player = document.getElementById("player" + (caller + 1).toString()).value;
            var datalist = document.getElementById("p" + (caller + 1).toString() + "drop");

            while (datalist.childElementCount > 0){
                datalist.removeChild(datalist.firstChild);
            }

            if (window.XMLHttpRequest){
                var req = new XMLHttpRequest();
            }
            else{
                var req = new ActiveXObject("Microsoft.XMLHTTP");
            }

            req.open("POST", "/autofill_matches/"+caller.toString(), true);
            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            req.onreadystatechange = function(){
                if (this.readyState == 4 && this.status == 200){
                    var response = this.responseText;
                    response = response.split("|");
                    for (var i = 0; i < (response.length)/2 - 1; i++){
                        var option = new Option("", response[2*i + 1]);
                        option.id = response[2*i];
                        datalist.appendChild(option);
                    }
                }
            };
            req.send("player" + (caller+1).toString() + "="+player);
        }

        function pickFirst(caller){
            var input = document.getElementById("player"+(caller).toString());
            var datalist = document.getElementById("p"+(caller).toString()+"drop");

            if (input.value == "")
                return;

            if (datalist.childElementCount > 0){
                input.value = datalist.firstChild.value;
            }
        }

        for (var i = 0; i < 2; i++){
            autofill_matches(i);
        }

        var select = "no id";

        document.onselectionchange = function(){
            try{
                if (select.substr(0,6) == "player" && document.getSelection().focusNode.firstChild.id != select){
                    pickFirst(select.substr(6,select.length));
                }

                if (document.getSelection().focusNode.firstChild.id.substr(0,6) == "player")
                    select = document.getSelection().focusNode.firstChild.id;
                else
                    select = "no id";
            }
            catch{
                select = "no id";
            }
        };

        function clickOne(caller){

        }
    </script>
</div>

{% endblock %}